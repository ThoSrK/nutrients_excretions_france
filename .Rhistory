mutate_all(~ifelse(is.nan(.), NA, .)) %>% #on remplace les NAN issus de la moyenne par des na
filter(is.na(valeur)==F)
N_P_in <- temp %>%
filter(
parametre %in% c("PT", "NGL"),
indicateur %in% c("POENT"))
test <- N_P_in %>%
filter(parametre == "NGL")
test <- N_P_in %>%
filter(parametre == "NGL") %>%
spread(key = parametre, value = valeur)
test <- anti_join(
N_P_in %>% group_by(code_rj, annee) %>% distinct(),
temp,
by=c("code_rj", "annee"))
test <- test %>%
filter(parametre == "NGL") %>%
spread(key = parametre, value = valeur)
test <- anti_join(
N_P_in %>% group_by(code_rj, annee) %>% distinct(),
temp,
by=c("code_rj", "annee"))
test <- anti_join(
N_P_in %>% group_by(code_rj, annee) %>% distinct(),
temp,
by=c("code_rj", "annee"))
test <- N_P_in %>% group_by(code_rj, annee) %>% distinct()
test <- N_P_in %>% group_by(annee, code_rj) %>% distinct()
test <- N_P_in %>% select(annee, code_rj)
test <- N_P_in %>% select(annee, code_rj) %>% distinct()
N_P_in <- temp %>%
filter(
parametre %in% c("PT", "NGL"),
indicateur %in% c("POENT")) %>%
select(-indicateur)
test <- N_P_in %>% select(annee, code_rj, parametre) %>% distinct()
temp <-  all_rejets %>%
# filter(
#   code_rj !="0564520V0011" & code_rj !="0519028V0011" &
#   code_rj !="0519069V0021" & code_rj !="0509047V0041" &
#   code_rj !="0532290V0021" & code_rj !="0531512V0011" &
#   code_rj !="0519176V0021" & code_rj !="0516028V0051" &
#   code_rj !="0565138V0031" & code_rj !="0511080V0011") %>% # la sation 0564520V0011 est en double !!!! avec des valeurs différentes
mutate(valeur = rowMeans(.[7:18], na.rm = T)) %>% #on fait la moyenne annuelle
#attention ici je prend la moyenne des rendements, chaque mois a le même poids. Pas forcément pertinent ?
#on peut aussi faire sum(in)/sum(out)
#ou weighted.meand(in/out, weight = in) donne plus de poids aux jours à fort débit
#donc à essayer pour voir ce que ça change
select(-valeur_01, -valeur_02, -valeur_03, -valeur_04, -valeur_05, -valeur_06, #on enlève valeurs mensuelles
-valeur_07, -valeur_08, -valeur_09, -valeur_10, -valeur_11, -valeur_12)
temp <- temp %>%
mutate(valeur = case_when(
is.na(valeur_y) == F ~ valeur_y, T~valeur)) %>% #on met les valeurs de boue avec les autres
select(-valeur_y, -type_rj) %>% #colonnes inutiles
mutate_all(~ifelse(is.nan(.), NA, .)) %>% #on remplace les NAN issus de la moyenne par des na
filter(is.na(valeur)==F)
N_P_in <- temp %>%
filter(
parametre %in% c("PT", "NGL"),
indicateur %in% c("POENT")) %>%
select(-indicateur)
test <- N_P_in %>% select(annee, code_rj, parametre) %>% distinct()
View(all_rejets)
View(N_P_in)
test2 <- left_join(N_P_in, test, by=c("annee", "code_rj", "parametre"))
test2 <- left_join(test, N_P_in, by=c("annee", "code_rj", "parametre"))
test2 <- anti_join(test, N_P_in, by=c("annee", "code_rj", "parametre"))
test2 <- anti_join(N_P_in, test, by=c("annee", "code_rj", "parametre"))
test2 <- anti_join(N_P_in, test, by=c("annee", "code_rj", "parametre"))
test2 <- N_P_in %>%
count(annee, code_rj, parametre)
View(test2)
test2 <- N_P_in %>%
count(annee, code_rj, parametre) %% filter(n==1) %>% select(-n)
test2 <- N_P_in %>%
count(annee, code_rj, parametre) %% filter(n == 1)
test2 <- N_P_in %>%
count(annee, code_rj, parametre) %% select(-n)
test2 <- N_P_in %>%
count(annee, code_rj, parametre)
test2$n
unique(test2$n)
test2 <- test2 %>% filter(n != 1)
test2 <- N_P_in %>%
count(annee, code_rj, parametre) %>% filter(n != 1)
N_P_in %>% group_by(Year, parametre) %>% summarise(valeur=sum(valeur))
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur))
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur)) %>% spread(parametre, valeur)
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur)) %>% spread(parametre, valeur) %>% mutate(ratio = NGL/PT)
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur)) %>% spread(parametre, valeur) %>% mutate(ratio = PT/NGL)
ggplot() + geom_line(aes(annee, ratio))
ggplot(N_P_in) + geom_line(aes(annee, ratio))
test <- test %>%
filter(parametre == "NGL") %>%
spread(key = parametre, value = valeur)
ggplot(N_P_in) + geom_line(aes(annee, ratio))
#ratio avec toutes les valeurs
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur)) %>% spread(parametre, valeur) %>% mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio))
#ratio avec toutes les valeurs
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur)) %>% spread(parametre, valeur) %>% mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio)) + ylim(0.NA)
#ratio avec toutes les valeurs
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur)) %>% spread(parametre, valeur) %>% mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio)) + ylim(0, NA)
all_rejets_before_2012 <- list.files( #read and merge csv of all years
path = paste(path, "donnees_rejets_collectivites_2000_2009/", sep = ""),
pattern = "*csv", full.names = T) %>% lapply(read.csv, sep = ";") %>% bind_rows
all_rejets_before_2010 <- list.files( #read and merge csv of all years
path = paste(path, "donnees_rejets_collectivites_2000_2009/", sep = ""),
pattern = "*csv", full.names = T) %>% lapply(read.csv, sep = ";") %>% bind_rows
View(all_rejets_before_2010)
all_rejets_before_2010 <- list.files( #read and merge csv of all years
path = paste(path, "donnees_rejets_collectivites_2000_2009/", sep = ""),
pattern = "listeDataIndicateurs_*", full.names = T) %>% lapply(read.csv, sep = ";") %>% bind_rows
View(all_rejets_before_2010)
all_rejets <- bind_rows(
all_rejets, all_rejets_before_2010
)
temp <-  all_rejets %>%
# filter(
#   code_rj !="0564520V0011" & code_rj !="0519028V0011" &
#   code_rj !="0519069V0021" & code_rj !="0509047V0041" &
#   code_rj !="0532290V0021" & code_rj !="0531512V0011" &
#   code_rj !="0519176V0021" & code_rj !="0516028V0051" &
#   code_rj !="0565138V0031" & code_rj !="0511080V0011") %>% # la sation 0564520V0011 est en double !!!! avec des valeurs différentes
mutate(valeur = rowMeans(.[7:18], na.rm = T)) %>% #on fait la moyenne annuelle
#attention ici je prend la moyenne des rendements, chaque mois a le même poids. Pas forcément pertinent ?
#on peut aussi faire sum(in)/sum(out)
#ou weighted.meand(in/out, weight = in) donne plus de poids aux jours à fort débit
#donc à essayer pour voir ce que ça change
select(-valeur_01, -valeur_02, -valeur_03, -valeur_04, -valeur_05, -valeur_06, #on enlève valeurs mensuelles
-valeur_07, -valeur_08, -valeur_09, -valeur_10, -valeur_11, -valeur_12)
temp <- temp %>%
mutate(valeur = case_when(
is.na(valeur_y) == F ~ valeur_y, T~valeur)) %>% #on met les valeurs de boue avec les autres
select(-valeur_y, -type_rj) %>% #colonnes inutiles
mutate_all(~ifelse(is.nan(.), NA, .)) %>% #on remplace les NAN issus de la moyenne par des na
filter(is.na(valeur)==F)
N_P_in <- temp %>%
filter(
parametre %in% c("PT", "NGL"),
indicateur %in% c("POENT")) %>%
select(-indicateur)
#ratio avec toutes les valeurs
N_P_in %>% group_by(annee, parametre) %>% summarise(valeur=sum(valeur)) %>% spread(parametre, valeur) %>% mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio)) + ylim(0, NA)
#ratio avec toutes les valeurs
N_P_in_sum <- N_P_in %>%
group_by(annee, parametre) %>%
summarise(valeur=sum(valeur)) %>%
spread(parametre, valeur) %>%
mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio)) + ylim(0, NA)
#ratio avec toutes les valeurs
N_P_in_sum <- N_P_in %>%
group_by(annee, parametre) %>%
summarise(valeur=sum(valeur)) %>%
spread(parametre, valeur) %>%
mutate(ratio = PT/NGL)
View(N_P_in_sum)
View(steu)
# ratio N/P ---------------------------------------------------------------
path <- "data/STEU/Adour_Garonne/"
all_rejets <- bind_rows(
read.csv(paste(path,"donnees_rejets_collectivites_2010/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2011/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2012/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2013/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2014/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2015/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2016/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2017/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2018/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2019/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2020/listeDataIndicateurs.csv", sep=""), sep=";"))
all_rejets_before_2010 <- list.files( #read and merge csv of all years
path = paste(path, "donnees_rejets_collectivites_2000_2009/", sep = ""),
pattern = "listeDataIndicateurs_*", full.names = T) %>% lapply(read.csv, sep = ";") %>% bind_rows
all_rejets <- bind_rows(all_rejets, all_rejets_before_2010)
temp <-  all_rejets %>%
# filter(
#   code_rj !="0564520V0011" & code_rj !="0519028V0011" &
#   code_rj !="0519069V0021" & code_rj !="0509047V0041" &
#   code_rj !="0532290V0021" & code_rj !="0531512V0011" &
#   code_rj !="0519176V0021" & code_rj !="0516028V0051" &
#   code_rj !="0565138V0031" & code_rj !="0511080V0011") %>% # la sation 0564520V0011 est en double !!!! avec des valeurs différentes
mutate(valeur = rowMeans(.[7:18], na.rm = T)) %>% #on fait la moyenne annuelle
#attention ici je prend la moyenne des rendements, chaque mois a le même poids. Pas forcément pertinent ?
#on peut aussi faire sum(in)/sum(out)
#ou weighted.meand(in/out, weight = in) donne plus de poids aux jours à fort débit
#donc à essayer pour voir ce que ça change
select(-valeur_01, -valeur_02, -valeur_03, -valeur_04, -valeur_05, -valeur_06, #on enlève valeurs mensuelles
-valeur_07, -valeur_08, -valeur_09, -valeur_10, -valeur_11, -valeur_12)
temp <- temp %>%
mutate(valeur = case_when(
is.na(valeur_y) == F ~ valeur_y, T~valeur)) %>% #on met les valeurs de boue avec les autres
select(-valeur_y, -type_rj) %>% #colonnes inutiles
mutate_all(~ifelse(is.nan(.), NA, .)) %>% #on remplace les NAN issus de la moyenne par des na
filter(is.na(valeur)==F)
unique(temp$annee)
View(temp)
test2 <- temp %>%
count(annee, code_rj, parametre, indicateur) %>% filter(n != 1)
View(test2)
unique(test2$code_rj)
test <- anti_join(temp, test2, by=c("annee","code_rj","parametre","indicateur"))
nrow(test)-nrow(temp)
nrow(test2)
test <- test %>%
filter(parametre == "NGL") %>%
spread(key = parametre, value = valeur)
table(N_P_in %>% filter(parametre =="NGL") %>% select(annee))
table(N_P_in %>% filter(parametre =="PT") %>% select(annee))
#voir celles qui font doublon, puis les enlever
doublons <- temp %>% count(annee, code_rj, parametre, indicateur) %>% filter(n != 1) #les identifier
# ratio N/P ---------------------------------------------------------------
path <- "data/STEU/Adour_Garonne/"
all_rejets <- bind_rows(
read.csv(paste(path,"donnees_rejets_collectivites_2010/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2011/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2012/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2013/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2014/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2015/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2016/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2017/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2018/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2019/listeDataIndicateurs.csv", sep=""), sep=";"),
read.csv(paste(path,"donnees_rejets_collectivites_2020/listeDataIndicateurs.csv", sep=""), sep=";"))
all_rejets_before_2010 <- list.files( #read and merge csv of all years
path = paste(path, "donnees_rejets_collectivites_2000_2009/", sep = ""),
pattern = "listeDataIndicateurs_*", full.names = T) %>% lapply(read.csv, sep = ";") %>% bind_rows
all_rejets <- bind_rows(all_rejets, all_rejets_before_2010)
temp <-  all_rejets %>%
# filter(
#   code_rj !="0564520V0011" & code_rj !="0519028V0011" &
#   code_rj !="0519069V0021" & code_rj !="0509047V0041" &
#   code_rj !="0532290V0021" & code_rj !="0531512V0011" &
#   code_rj !="0519176V0021" & code_rj !="0516028V0051" &
#   code_rj !="0565138V0031" & code_rj !="0511080V0011") %>% # la sation 0564520V0011 est en double !!!! avec des valeurs différentes
mutate(valeur = rowMeans(.[7:18], na.rm = T)) %>% #on fait la moyenne annuelle
#attention ici je prend la moyenne des rendements, chaque mois a le même poids. Pas forcément pertinent ?
#on peut aussi faire sum(in)/sum(out)
#ou weighted.meand(in/out, weight = in) donne plus de poids aux jours à fort débit
#donc à essayer pour voir ce que ça change
select(-valeur_01, -valeur_02, -valeur_03, -valeur_04, -valeur_05, -valeur_06, #on enlève valeurs mensuelles
-valeur_07, -valeur_08, -valeur_09, -valeur_10, -valeur_11, -valeur_12)
temp <- temp %>%
mutate(valeur = case_when(
is.na(valeur_y) == F ~ valeur_y, T~valeur)) %>% #on met les valeurs de boue avec les autres
select(-valeur_y, -type_rj) %>% #colonnes inutiles
mutate_all(~ifelse(is.nan(.), NA, .)) %>% #on remplace les NAN issus de la moyenne par des na
filter(is.na(valeur)==F)
#voir celles qui font doublon, puis les enlever
doublons <- temp %>% count(annee, code_rj, parametre, indicateur) %>% filter(n != 1) #les identifier
temp <- anti_join(temp, doublons, by=c("annee","code_rj","parametre","indicateur")) #les retrier du fichier principal
nrow(test)-nrow(temp)
View(temp)
#mettre en colonne les indicateurs (permet aussi de voir si le retrait des doublons a bien marché)
temp <- temp %>%
spread(key = parametre, value = valeur)
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% mutate(ratio = PT/NGL)
View(g)
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
group_by(annee) %>%
summarise(PT=sum(PT), NGL=sum(NGL)) %>%
mutate(ratio = PT/NGL)
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
group_by(annee) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL)
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL)
ggplot() + geom_line(aes(annee, ratio)) + ylim(0, NA) + facet_wrap(vars(indicateur))
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA)
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL)
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA)
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA)
g
#ratio entrant
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA) + ylab("P total / N total")
g
#ratio entrant
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
mutate(indicateur = case_when(
indicateur == "POENT" ~ "entrée",
indicateur == "POSOR" ~ "sortie",
T ~ indicateur,
))
#ratio entrant
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
mutate(indicateur = case_when(
indicateur == "POENT" ~ "entrée",
indicateur == "POSOR" ~ "sortie",
T ~ indicateur))
#ratio entrant
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
mutate(indicateur = case_when(
indicateur == "POENT" ~ "entrée",
indicateur == "POSOR" ~ "sortie"))
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA) + ylab("P total / N total")
#ratio entrant
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
mutate(indicateur = case_when(
indicateur == "POENT" ~ "entrée",
indicateur == "POSOR" ~ "sortie")) %>%
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA) + ylab("P total / N total")
g
#voir l'évolution temporelle du nb de données rapportées
table(N_P_in %>% filter(parametre =="NGL") %>% select(annee))
#voir l'évolution temporelle du nb de données rapportées
test <- table(N_P_in %>% filter(parametre =="NGL") %>% select(annee))
#voir l'évolution temporelle du nb de données rapportées
test <- as.data.frame(table(N_P_in %>% filter(parametre =="NGL") %>% select(annee)))
View(test)
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(N_P_in %>% filter(parametre =="NGL") %>% select(annee))) %>%
ggplot() + geom_line(aes(anne, freq))
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(N_P_in %>% filter(parametre =="NGL") %>% select(annee))) %>%
ggplot() + geom_line(aes(annee, freq))
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee, PT))) %>%
ggplot() + geom_line(aes(annee, freq))
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee, PT)))
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee)))
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee))) %>%
ggplot() + geom_line(aes(annee, Freq))
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee)))
#voir l'évolution temporelle du nb de données rapportées
g <- as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee)))
View(g)
ggplot(g) + geom_line(aes(annee, Freq))
ggplot(g) + geom_point(aes(annee, Freq))
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee))) %>%
ggplot(g) + geom_point(aes(annee, Freq)) + ylim(0, NA)
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur =="POENT") %>% select(annee))) %>%
ggplot() + geom_point(aes(annee, Freq)) + ylim(0, NA)
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(annee, indicateur))) %>%
ggplot() + geom_point(aes(annee, Freq, colour = indicateur)) + ylim(0, NA)
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp  %>% select(annee, indicateur))) %>%
ggplot() + geom_point(aes(annee, Freq, colour = indicateur)) + ylim(0, NA)
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp  %>% select(annee, indicateur))) %>%
ggplot() + geom_line(aes(annee, Freq, colour = indicateur)) + ylim(0, NA)
#voir l'évolution temporelle du nb de données rapportées
as.data.frame(table(temp  %>% select(annee, indicateur))) %>%
ggplot() + geom_point(aes(annee, Freq, colour = indicateur)) + ylim(0, NA)
#ratio entrant
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
mutate(indicateur = case_when(
indicateur == "POENT" ~ "entrée",
indicateur == "POSOR" ~ "sortie")) %>%
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA) + ylab("P total / N total")
#ratio entrant
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>%
mutate(indicateur = case_when(
indicateur == "POENT" ~ "entrée",
indicateur == "POSOR" ~ "sortie")) %>%
group_by(annee, indicateur) %>%
summarise(PT=sum(PT, na.rm=T), NGL=sum(NGL, na.rm=T)) %>%
mutate(ratio = PT/NGL) %>%
ggplot() + geom_line(aes(annee, ratio, color=indicateur)) + ylim(0, NA) + ylab("P total / N total")
ggsave("graphs/Adour_Garonne/ratio.pdf", g, w=6, h=4)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR"))
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(NGL, PT)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR"))
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = NGL, PT)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T),
)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T))
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T)) %>%
mutate(yield = 1-POSOR/POENT)
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T)) %>%
mutate(yield = 1-POSOR/POENT) %>%
ggplot() + geom_line(aes(annee, yield, fill = pollution))
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T)) %>%
mutate(yield = 1-POSOR/POENT) %>%
ggplot() + geom_line(aes(annee, yield, colour = pollution))
g
#rendement globale
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T)) %>%
mutate(yield = (1-POSOR/POENT)*100) %>%
ggplot() + geom_line(aes(annee, yield, colour = pollution)) + ylim(0,NA) +
ylab("rendement global sur les stations d'Adour-Garonne")
g
#rendement global temporel
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T)) %>%
mutate(yield = (1-POSOR/POENT)*100) %>%
ggplot() + geom_line(aes(annee, yield, colour = pollution)) + ylim(0,NA) +
ylab("rendement global sur les stations d'Adour-Garonne")
ggsave("graphs/Adour_Garonne/rendment_temporel.pdf", g, w=6, h=4)
ggsave("graphs/Adour_Garonne/rendement_temporel.pdf", g, w=6, h=4)
as.data.frame(table(temp  %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(annee, indicateur))) %>%
ggplot() + geom_point(aes(annee, Freq, colour = indicateur)) + ylim(0, NA)
#rendement global temporel
g <- temp %>% filter(indicateur %in% c("POENT", "POSOR")) %>% select(code_rj, annee, indicateur, NGL, PT) %>%
gather(key = pollution, value = valeur, NGL:PT) %>% spread(key = indicateur, value = valeur) %>%
group_by(annee, pollution) %>% summarise(
POENT = sum(POENT, na.rm = T),
POSOR = sum(POSOR, na.rm = T)) %>%
mutate(yield = (1-POSOR/POENT)*100) %>%
ggplot() + geom_line(aes(annee, yield, colour = pollution)) + ylim(0,100) +
ylab("rendement global sur les stations d'Adour-Garonne")
ggsave("graphs/Adour_Garonne/rendement_temporel.pdf", g, w=6, h=4)
nrow(steu)
nrow(temp %>% filter(annee == 200))
nrow(temp %>% filter(annee == 2000))
nrow(temp %>% filter(annee == 2000) %>% group_by(code_rj))
#phosphore
data_PT <- all_data %>% filter(parametre == "PT") %>% #4456 obs
spread(indicateur, valeur) %>%
mutate(rendement = 1-POSOR/POENT) #calcul du rendement
n1 <- nrow(data_PT)
data_PT <- data_PT %>% #4489 obs qui ne sont pas na
filter(is.na(rendement) == F)
n2 <- nrow(data_PT)
data_PT <- data_PT %>% #4140 obs qui n'ont pas un rendement incohérent
filter(rendement >=0 & rendement<=1)
n3 <- nrow(data_PT)
(1-n3/n2)*100 # pourcentage de valeurs incohérentes
(1-n2/n1)*100 # pourcentage de valeurs vides
#azote
data_NGL <- all_data %>% filter(parametre == "NGL") %>% #4456 obs
spread(indicateur, valeur) %>%
mutate(rendement = 1-POSOR/POENT) #calcul du rendement
#distribution des rendements sur toutes les stations
g <- ggplot(data_PT) +
geom_density(aes(rendement, color = "no weight")) +   xlim(0,1) +
geom_density(aes(rendement, weight = POENT/sum(POENT), color = "P in weight"))  +
geom_vline(aes(xintercept = mean(rendement), color = "no weight"), linetype = "dashed") +
geom_vline(aes(xintercept = weighted.mean(rendement, POENT), color = "P in weight"), linetype = "dashed")
ggsave("graphs/Adour_Garonne/P_yield.pdf", g, w=6, h=4)
mean(data_PT$rendement, na.rm = T) #rendement moyen non pondéré
weighted.mean(data_PT$rendement, data_PT$POENT, nar.rm = T) #rendement moyen pondéré par P entrant
